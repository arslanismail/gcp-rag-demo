<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCP RAG Demo</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .search-box { width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; }
        .search-btn { padding: 12px 24px; font-size: 16px; background: #4285f4; color: white; border: none; border-radius: 8px; cursor: pointer; margin-left: 10px; }
        .init-btn { padding: 8px 16px; background: #34a853; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 20px; }
        .response { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .products { display: grid; gap: 15px; margin-top: 20px; }
        .product { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .product:hover { border-color: #1a73e8; box-shadow: 0 2px 8px rgba(26, 115, 232, 0.1); transform: translateY(-1px); }
        .product h3 { margin: 0 0 10px 0; color: #1a73e8; }
        .price { font-weight: bold; color: #137333; }
        .similarity { font-size: 12px; color: #666; }
        .loading { color: #666; font-style: italic; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 30px; border-radius: 12px; width: 80%; max-width: 600px; position: relative; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        .product-detail h2 { color: #1a73e8; margin-bottom: 15px; }
        .product-detail .category { background: #e8f0fe; color: #1a73e8; padding: 4px 12px; border-radius: 16px; font-size: 14px; display: inline-block; margin-bottom: 15px; }
        .product-detail .price-large { font-size: 24px; font-weight: bold; color: #137333; margin: 15px 0; }
        .product-detail .description { line-height: 1.6; margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>GCP RAG Product Search Demo</h1>
    
    <button class="init-btn" onclick="initializeProducts()">Initialize Products</button>
    
    <div style="display: flex; margin-bottom: 20px;">
        <input type="text" class="search-box" id="searchInput" placeholder="Search for products..." onkeypress="handleKeyPress(event)">
        <button class="search-btn" onclick="searchProducts()">Search</button>
    </div>
    
    <div id="results"></div>

    <!-- Product Detail Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalProductContent"></div>
        </div>
    </div>

    <script>
        async function initializeProducts() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Initializing products with embeddings... (this may take 30-60 seconds)</div>';
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minute timeout
                
                const response = await fetch('/api/init', { 
                    method: 'POST',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                resultsDiv.innerHTML = `<div class="response">${data.message}</div>`;
            } catch (error) {
                if (error.name === 'AbortError') {
                    resultsDiv.innerHTML = '<div class="response">Error: Request timed out. Check server logs and ensure GCP credentials are set up correctly.</div>';
                } else {
                    resultsDiv.innerHTML = `<div class="response">Error: ${error.message}</div>`;
                }
            }
        }

        async function searchProducts() {
            const query = document.getElementById('searchInput').value;
            if (!query.trim()) return;
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Searching...</div>';
            
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                
                const data = await response.json();
                
                let html = '';
                if (!data.ragInitialized) {
                    html += '<div class="response" style="background: #fff3cd; border-left: 4px solid #ffc107;"><strong>Note:</strong> RAG system not initialized. Click "Initialize Products" first for product-specific responses.</div>';
                }
                html += `<div class="response"><h3>AI Response:</h3><p>${data.response}</p></div>`;
                html += '<div class="products">';
                
                if (data.products && data.products.length > 0) {
                    data.products.forEach(product => {
                        html += `
                            <div class="product" onclick="showProductDetail(${JSON.stringify(product).replace(/"/g, '&quot;')})">
                                <h3>${product.name}</h3>
                                <p>${product.description}</p>
                                <div class="price">$${product.price}</div>
                                <div class="similarity">Similarity: ${(product.similarity * 100).toFixed(1)}%</div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p>No products found.</p>';
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="response">Error: ${error.message}</div>`;
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                searchProducts();
            }
        }

        function showProductDetail(product) {
            const modal = document.getElementById('productModal');
            const modalContent = document.getElementById('modalProductContent');
            
            modalContent.innerHTML = `
                <div class="product-detail">
                    <h2>${product.name}</h2>
                    <div class="category">${product.category}</div>
                    <div class="description">${product.description}</div>
                    <div class="price-large">$${product.price}</div>
                    <p><strong>Product ID:</strong> ${product.id}</p>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('productModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>